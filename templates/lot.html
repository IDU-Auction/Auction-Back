{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1" />
    <title>E-Auction</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link rel="stylesheet" href="{% static 'styles/shared.css' %}">
    <link rel="stylesheet" href="{% static 'styles/lot.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
</head> 
<body>
    <!-- Header section -->
    {% include 'header.html' %}
    <!-- /Header section -->

    <!-- Lot section -->
        <section class="lot">
            <div class="container">
                <div class="breadcrumbs">
                    <a href="index.html">Home</a>
                    <i class="fa-solid fa-chevron-right"></i>
                    <a href="lots.html">Lots</a>
                    <i class="fa-solid fa-chevron-right"></i>
                    <a href="lot.html" class="active">Lot ID</a>
                </div>
                <div class="lot-detail">
                    <div class="lot-card__image">
                        <div class="lot-image">
                            <img src="{{ product.image.url }}" alt="{{ product.name }}">
                        </div>
                    </div>
                    <div class="lot-card__details">
                        <div class="lot-id">
                            <span class="lot-card-number-title">Lot #</span>
                            <span class="lot-card-number">{{ product.id }}</span>
                        </div>
                        <div class="lot-title">
                            {{ product.name }}
                        </div>
                        <div class="lot-card-attributes">
                            <div class="d-flex">
                                <div class="lot-card__info">
                                    <div class="lot-card-attribute__title">
                                        <img src="{% static 'images/lot-detail-images/application_date_icon.png' %}" alt="Application_daeadline">
                                        <span>Application Deadline</span>
                                    </div>
                                    <div class="lot-card-attribute__value">{{ product.end_time }}</div>
                                </div>
                                <div class="lot-card__info">
                                    <div class="lot-card-attribute__title">
                                        <img src="{% static 'images/lot-detail-images/end_auction_date.png' %}" alt="end auctions">
                                        <span>Auction time</span>
                                    </div>
                                    <div class="lot-card-attribute__value">-------</div>
                                </div>
                            </div>
                            <div class="d-flex">
                                <div class="lot-card__info">
                                    <div class="lot-card-attribute__title">
                                        <img src="{% static 'images/lot-detail-images/baholangan_narx_icon.png' %}" alt="actual price">
                                        <span>Starting Price</span>
                                    </div>
                                    <div class="lot-card-attribute__value">{{ product.initial_price }} UZS</div>
                                </div>
                                <div class="lot-card__info">
                                    <div class="lot-card-attribute__title">
                                        <img src="{% static 'images/lot-detail-images/zakalad_icon.png' %}" alt="deposite">
                                        <span>Deposite amount (10%)</span>
                                    </div>
                                    <div class="lot-card-attribute__value">-----------</div>
                                </div>
                            </div>
                            <div class="d-flex">
                                <div class="lot-card__info">
                                    <div class="lot-card-attribute__title">
                                        <img src="{% static 'images/lot-detail-images/type_auction.png' %}" alt="actual price">
                                        <span>Bidding method</span>
                                    </div>
                                    <div class="lot-card-attribute__value">Auction</div>
                                </div>
                                <div class="lot-card__info">
                                    <div class="lot-card-attribute__title">
                                        <img src="{% static 'images/lot-detail-images/sort_auction_icon.png' %}" alt="deposite">
                                        <span>Bidding method</span>
                                    </div>
                                    <div class="lot-card-attribute__value">On increasing</div>
                                </div>
                            </div>
                            <div class="d-flex">
                                <div class="lot-card__info">
                                    <div class="lot-card-attribute__title">
                                        <i class="fa-solid fa-list-ul"></i>
                                        <span>First step (5%)</span>
                                    </div>
                                    <div class="lot-card-attribute__value">-------------- UZS</div>
                                </div>
                            </div>
                            <div class="d-flex">
                                <div>
                                    <div class="lot-card-attribute__title">
                                        <i class="fa-solid fa-location-dot"></i>
                                        <span>Address</span>
                                    </div>
                                    <div class="lot-card-attribute__value">------------------------</div>
                                </div>
                            </div>
                            <div class="d-flex">
                                <div>
                                    <div class="lot-card-attribute__title">
                                        <i class="fa-solid fa-exclamation"></i>
                                        <span>Lot status</span>
                                    </div>
                                    <div class="lot-card-attribute__value" style="color: #388e3c;">
                                        {% if product.auction %}
                                            Acceptance of electronic applications for participation
                                        {% else %}
                                            CLOSED
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="lot-card-statistics">
                                <ul class="lot-statistics-icons">
                                    <li class="lot-icon">
                                        <i class="fa-regular fa-user"></i>
                                        <span>10</span>
                                    </li>
                                    <li class="lot-icon">
                                        <i class="fa-regular fa-eye"></i>
                                        <span>340</span>
                                    </li>
                                    <li class="lot-icon">
                                        <i class="fa-regular fa-heart"></i>
                                        <span>275</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="extra-lot__detail">

                </div>
            </div>
        </section>
    <!-- /Lot section -->

    {% if user.is_authenticated %}
    <div class="row">
        <div class="col-md-4 mb-3">
            <h4>{{product.name}}</h4>
            <h5>{{product.initial_price}} so'm</h5>
            <p>Time left: <span id="timer"></span></p>
            <h5>{{product.description}}</h5>
            <div id="price-adding">
                <input type="number" id="price-input" placeholder="Enter price" />
                <button id="add-price-btn">Add Price</button>
            </div>        
        </div>
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-body table-responsive p-0">
                    <table class="table table-striped text-nowrap">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in product.prices %}
                            <tr>
                                <td>{{item.user.username}}</td>
                                <td>{{item.price}}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const endTime = "{{ product.end_time|date:'c' }}"; // ISO 8601 format
        function startCountdown(endTime) {
            const timerElement = document.getElementById('timer');
            const endDate = new Date(endTime).getTime();
    
            function updateTimer() {
                const now = new Date().getTime();
                const timeLeft = endDate - now;
    
                if (timeLeft <= 0) {
                    timerElement.innerHTML = "Time's up!";
                    clearInterval(intervalId);
    
                    // Disable price adding
                    const price_adding = document.getElementById('price-adding')
                    if (price_adding) {
                        price_adding.remove()
                    }
    
                    return;
                }
    
                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
    
                timerElement.innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            }
    
            const intervalId = setInterval(updateTimer, 1000);
            updateTimer(); // Call once immediately
        }
        startCountdown(endTime);
    
        const productId = '{{ product.id }}';
        const userId = '{{ request.user.id }}'; // Pass the user's ID if authenticated
        const ws = new WebSocket(`ws://${window.location.host}/ws/prices/${productId}/`);
    
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            const prices = data.prices;
    
            const tableBody = document.querySelector('table tbody');
            tableBody.innerHTML = ''; // Clear the table
    
            // Populate table with updated price list
            prices.forEach(price => {
                const newRow = document.createElement('tr');
                newRow.innerHTML = `<td>${price.user__full_name}</td><td>${price.price}</td>`;
                tableBody.appendChild(newRow);
            });
        };
    
        ws.onclose = function() {
            console.error('WebSocket closed unexpectedly');
        };
    
        // Example: Send a new price to the server
        document.getElementById('add-price-btn').addEventListener('click', () => {
            const priceValue = document.getElementById('price-input').value;
    
            if (priceValue) {
                ws.send(JSON.stringify({
                    user_id: userId,
                    price: priceValue,
                }));
            }
        });
    </script>
    {% endif %}

    <!-- Footer section -->
    {% include 'footer.html' %}
    <!-- /Footer section -->

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="{% static 'js/shared.js' %}"></script>
</body>
</html>
